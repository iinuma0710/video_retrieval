<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Retrieval Page</title>
  </head>
  <body>
    <h1>Video retrieval</h1>
    
    <form action="/retrieval" method="POST" enctype="multipart/form-data">
      <h3>Path to the query video：</h3>
      <input type="text" name="query_video" placeholder="Query video">
      <h3>Path to the data directory：</h3>
      <input type="text" name="gallery_dir" placeholder="Data directory">
      <h3>Upper limit of person retrieval：</h3>
      <input type="text" name="person_ret_num" value="5000">
      <h3>The number of the results：</h3>
      <input type="text" name="action_ret_num" value="100">
      <br><br>
      <!-- <label for="add_to_query">クエリをデータベースに追加：</label> -->
      <!-- <input type="checkbox" id="add_to_query" name="add_to_query" value=1> -->
      <!-- <br> -->
      <label for="person_only">Only person retrieval：</label>
      <input type="checkbox" id="person_only" name="person_only" value=1>
      <br>
      <label for="action_only">Only action retrieval：</label>
      <input type="checkbox" id="action_only" name="action_only" value=1>
      <br>
      <label for="fusion">Fusion retrieval：</label>
      <input type="checkbox" id="fusion" name="fusion" value=1>
      <br><br><br>
      <input type="submit" value="Retrieval">
    </form>

    <h2>Retrieval Results ({{ file_num }} videos)：</h2>
    {% for i in range(file_num) %}
      <p>{{ i + 1 }} : {{ file_list[i] }}</p>
      <div>
        <label for="{{ action_id_list[i] }}">Action {{ i + 1 }}：</label>
        <input type="checkbox" id="{{ action_id_list[i] }}" value=1>，
        <label for="{{ person_id_list[i] }}">Person {{ i + 1 }}：</label>
        <input type="checkbox" id="{{ person_id_list[i] }}" value=1>
      </div>
      <video src="{{ display_file_list[i] }}" loop autoplay muted></video>
    {% endfor %}

    <div>
      <input type="button" value="Calculate AP" onclick="buttonClick()">
      <label for="exclude_top">Remove Top 1 retrieval：</label>
      <input type="checkbox" id="exclude_top" value=1>
    </div>
  </body>
</html>

<script type="text/javascript">
  var action_id_list = {{ action_id_list | tojson }};
  var person_id_list = {{ person_id_list | tojson }};

  function buttonClick() {
    var exclude_top = document.getElementById("exclude_top").checked;

    var action_total_num = 0;
    var action_correct_num = 0;
    var action_ap = 0.0;
    for (let action_id of action_id_list) {
      if (exclude_top && action_id === "action_1") { continue }
      action_total_num += 1
      if (document.getElementById(action_id).checked) {
        action_correct_num += 1;
        action_ap += action_correct_num / action_total_num
      }
    }
    action_ap = action_correct_num == 0 ? 0.0 : action_ap / action_correct_num

    var person_total_num = 0;
    var person_correct_num = 0;
    var person_ap = 0.0;
    for (let person_id of person_id_list) {
      if (exclude_top && person_id === "person_1") { continue }
      person_total_num += 1
      if (document.getElementById(person_id).checked) {
        person_correct_num += 1;
        person_ap += person_correct_num / person_total_num
      }
    }
    person_ap = person_correct_num == 0 ? 0.0 : person_ap / person_correct_num


    alert("Action retrieval：" + action_ap + " (" + action_correct_num + "/" + action_total_num +")\nPerson retrieval：" + person_ap + " (" + person_correct_num + "/" + person_total_num +")");
  }
</script>
